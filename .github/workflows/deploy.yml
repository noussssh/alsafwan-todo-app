name: Deploy Al Safwan Marine Todo App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build for Linux
      run: |
        go mod tidy
        GOOS=linux GOARCH=amd64 go build -o todo-app-linux main.go

    - name: Copy app and static files to server
      run: |
        sudo apt-get update && sudo apt-get install -y sshpass rsync

        # Copy binary
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no todo-app-linux "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/alsafwan/alsafwanmarine-project/applications/site1/"

        # Copy static files using rsync
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz -e "ssh -o StrictHostKeyChecking=no" web/ "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/alsafwan/alsafwanmarine-project/applications/site1/web/"

    - name: Deploy and restart service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /home/alsafwan/alsafwanmarine-project/applications/site1/
          sudo systemctl stop site1 || true
          chmod +x todo-app-linux
          cp todo-app-linux site1
          sudo systemctl start site1
          echo "âœ… Todo App deployed with static files!"
