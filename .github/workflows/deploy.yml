name: Deploy Al Safwan Marine Todo App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Build for Linux
      run: |
        go mod tidy
        GOOS=linux GOARCH=amd64 go build -o todo-app-linux main.go

    - name: Deploy to Al Safwan Marine Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Navigate to site1 directory
          cd /home/alsafwan/alsafwanmarine-project/applications/site1/

          # Stop current site1 service
          sudo systemctl stop site1 || true

          # Download the built app (we'll copy it via scp separately)
          echo "ðŸš€ Ready to receive new todo app..."

    - name: Copy app to server
      run: |
        # Install sshpass for password authentication
        sudo apt-get update && sudo apt-get install -y sshpass

        # Copy the Linux binary to server
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no todo-app-linux ${{ secrets.SERVER_USER }}@${{
secrets.SERVER_HOST }}:/home/alsafwan/alsafwanmarine-project/applications/site1/

    - name: Start new app
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /home/alsafwan/alsafwanmarine-project/applications/site1/
          chmod +x todo-app-linux
          cp todo-app-linux site1
          sudo systemctl start site1
          echo "âœ… Al Safwan Marine Todo App deployed successfully!"
