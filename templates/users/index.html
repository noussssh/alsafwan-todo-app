{{define "content"}}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted">Manage system users and their permissions</p>
    </div>
    <div>
        {{if or (eq .User.Role 0) (eq .User.Role 1)}}
        <a href="/users/new" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Add New User
        </a>
        {{end}}
    </div>
</div>

<!-- Search and Filter -->
<div class="card shadow mb-4">
    <div class="card-body">
        <form method="GET" action="/users" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" 
                       placeholder="Name or email..." value="{{.SearchQuery}}">
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">Role</label>
                <select class="form-select" id="role" name="role">
                    <option value="">All Roles</option>
                    {{if eq .User.Role 0}}
                    <option value="0" {{if eq .FilterRole "0"}}selected{{end}}>Administrator</option>
                    <option value="1" {{if eq .FilterRole "1"}}selected{{end}}>Manager</option>
                    {{end}}
                    <option value="2" {{if eq .FilterRole "2"}}selected{{end}}>Salesperson</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="enabled" {{if eq .FilterStatus "enabled"}}selected{{end}}>Enabled</option>
                    <option value="disabled" {{if eq .FilterStatus "disabled"}}selected{{end}}>Disabled</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-users"></i> Users ({{len .Users}})
        </h6>
        {{if and (or (eq .User.Role 0) (eq .User.Role 1)) (gt (len .Users) 1)}}
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i> Bulk Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkPasswordResetModal">
                    <i class="fas fa-key"></i> Reset Passwords
                </a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkEnableModal">
                    <i class="fas fa-toggle-on"></i> Enable Selected
                </a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkDisableModal">
                    <i class="fas fa-toggle-off"></i> Disable Selected
                </a></li>
            </ul>
        </div>
        {{end}}
    </div>
    <div class="card-body p-0">
        {{if .Users}}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        {{if and (or (eq .User.Role 0) (eq .User.Role 1)) (gt (len .Users) 1)}}
                        <th width="40">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        {{end}}
                        <th>User</th>
                        <th>Role</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Users}}
                    <tr>
                        {{if and (or (eq $.User.Role 0) (eq $.User.Role 1)) (gt (len $.Users) 1)}}
                        <td>
                            {{if ne .ID $.User.ID}}
                            <input type="checkbox" class="form-check-input user-checkbox" value="{{.ID}}">
                            {{end}}
                        </td>
                        {{end}}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-3">
                                    <i class="fas fa-user-circle fa-2x text-{{if .Enabled}}primary{{else}}muted{{end}}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">{{.Name}}</h6>
                                    <small class="text-muted">{{.Email}}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{{if eq .Role 0}}danger{{else if eq .Role 1}}warning{{else}}info{{end}}">
                                {{if eq .Role 0}}Admin{{else if eq .Role 1}}Manager{{else}}Sales{{end}}
                            </span>
                        </td>
                        <td>
                            {{if .Company}}
                                <small class="text-muted">{{.Company}}</small>
                            {{else}}
                                <small class="text-muted">-</small>
                            {{end}}
                        </td>
                        <td>
                            {{if .Enabled}}
                                <span class="badge bg-success">Active</span>
                            {{else}}
                                <span class="badge bg-danger">Disabled</span>
                            {{end}}
                        </td>
                        <td>
                            {{if .LastSignInAt}}
                                <small class="text-muted">{{.LastSignInAt.Format "Jan 02, 15:04"}}</small>
                            {{else}}
                                <small class="text-muted">Never</small>
                            {{end}}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/users/{{.ID}}" class="btn btn-outline-primary btn-sm" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {{if or (eq $.User.Role 0) (and (eq $.User.Role 1) (eq .Role 2))}}
                                <a href="/users/{{.ID}}/edit" class="btn btn-outline-secondary btn-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <div class="dropdown">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" title="More">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/users/{{.ID}}/reset-password">
                                            <i class="fas fa-key"></i> Reset Password
                                        </a></li>
                                        {{if and (eq .Role 2) (ne .ID $.User.ID)}}
                                        <li><a class="dropdown-item" href="/users/{{.ID}}/toggle-status"
                                               data-confirm="Are you sure you want to {{if .Enabled}}disable{{else}}enable{{end}} this user?">
                                            <i class="fas fa-toggle-{{if .Enabled}}off{{else}}on{{end}}"></i> 
                                            {{if .Enabled}}Disable{{else}}Enable{{end}}
                                        </a></li>
                                        {{end}}
                                        {{if and (ne .ID $.User.ID) (or (eq $.User.Role 0) (and (eq $.User.Role 1) (eq .Role 2)))}}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="/users/{{.ID}}/delete"
                                               data-confirm="Are you sure you want to delete this user? This action cannot be undone.">
                                            <i class="fas fa-trash"></i> Delete
                                        </a></li>
                                        {{end}}
                                    </ul>
                                </div>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No users found</h5>
            <p class="text-muted">Try adjusting your search criteria</p>
            {{if or (eq .User.Role 0) (eq .User.Role 1)}}
            <a href="/users/new" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Add First User
            </a>
            {{end}}
        </div>
        {{end}}
    </div>
</div>

<!-- Bulk Action Modals -->
{{if and (or (eq .User.Role 0) (eq .User.Role 1)) (gt (len .Users) 1)}}
<!-- Bulk Password Reset Modal -->
<div class="modal fade" id="bulkPasswordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/users/bulk/reset-passwords">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Password Reset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Reset passwords for selected users? New passwords will be generated and must be communicated to users.</p>
                    <div class="mb-3">
                        <label for="resetReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="resetReason" name="reason" required></textarea>
                    </div>
                    <input type="hidden" id="bulkResetUserIds" name="user_ids" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Reset Passwords</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Other bulk action modals would go here -->
{{end}}

<script>
// Handle select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Handle bulk actions
document.querySelectorAll('[data-bs-target*="bulk"]').forEach(button => {
    button.addEventListener('click', function() {
        const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (selectedUsers.length === 0) {
            alert('Please select at least one user');
            return false;
        }
        // Set the user IDs in the appropriate form
        const targetModal = this.getAttribute('data-bs-target');
        const hiddenInput = document.querySelector(targetModal + ' input[name="user_ids"]');
        if (hiddenInput) {
            hiddenInput.value = selectedUsers.join(',');
        }
    });
});
</script>
{{end}}